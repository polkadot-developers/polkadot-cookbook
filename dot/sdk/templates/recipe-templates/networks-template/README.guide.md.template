---
title: {{title}}
description: {{description}}

---

# {{title}}

{{description}}

## Overview

A focused guide for testing blockchain applications using Chopsticks and Zombienet. This guide shows you how to quickly set up test environments, fork chains, and write comprehensive tests.

**Prerequisites:**
- Node.js 20+
- Docker (for Zombienet)
- Basic testing knowledge

## Quick Start

```bash
cd recipes/{{slug}}
npm install

# Chopsticks: Fork live chains
npm run chopsticks

# Zombienet: Spawn test network
npm run zombienet

# Run tests
npm test
```

## Chopsticks Setup

### Configuration

`configs/chopsticks.yml`:

```yaml
relay_chain:
  endpoint: wss://westend-rpc.polkadot.io
  block: 12345678  # Use specific block for consistency
  port: 8000

parachains:
  - id: 1000
    endpoint: wss://westend-asset-hub-rpc.polkadot.io
    block: 12345678
    port: 8001
```

### Start Chopsticks

```bash
# Start all chains
npm run chopsticks

# Single chain
npx chopsticks --endpoint=wss://rpc.polkadot.io --block=12345678

# Custom config
npx chopsticks --config=custom.yml
```

### Connect to Forked Chain

```typescript
import { createClient } from "polkadot-api";
import { getWsProvider } from "polkadot-api/ws-provider/web";

const provider = getWsProvider("ws://localhost:8000");
const client = createClient(provider);
const api = client.getTypedApi(descriptor);
```

## Basic Testing

### Test Structure

```typescript
import { describe, it, expect, beforeAll, afterAll } from "vitest";
import { setupChains } from "@acala-network/chopsticks-testing";

describe("Chain Tests", () => {
  let chain, api;

  beforeAll(async () => {
    chain = await setupChains({
      endpoint: "wss://westend-rpc.polkadot.io",
      block: 12345678
    });

    const provider = getWsProvider(chain.wsUrl);
    const client = createClient(provider);
    api = client.getTypedApi(descriptor);
  });

  afterAll(async () => {
    await client.destroy();
  });

  it("reads chain state", async () => {
    const block = await api.query.System.Number.getValue();
    expect(block).toBe(12345678);
  });
});
```

### Query Testing

```typescript
it("queries account balance", async () => {
  const account = await api.query.System.Account.getValue(address);
  expect(account.data.free).toBeGreaterThan(0n);
});

it("queries storage map", async () => {
  const entries = await api.query.System.Account.getEntries();
  expect(entries.length).toBeGreaterThan(0);
});
```

### Transaction Testing

```typescript
it("submits transaction", async () => {
  const tx = api.tx.Balances.transfer_allow_death({
    dest: recipient,
    value: 1_000_000_000n
  });

  await tx.signAndSubmit(signer);

  // Advance chain
  await chain.newBlock();

  // Verify result
  const account = await api.query.System.Account.getValue(recipient);
  expect(account.data.free).toBeGreaterThan(0n);
});
```

## State Manipulation

### Set Storage

```typescript
import { setStorage } from "@acala-network/chopsticks-testing";

// Set account balance
await setStorage(chain, {
  System: {
    Account: [
      [address, {
        data: {
          free: 1000000000000n,
          reserved: 0n,
          frozen: 0n
        },
        nonce: 0,
        consumers: 0,
        providers: 1,
        sufficients: 0
      }]
    ]
  }
});

// Set custom pallet storage
await setStorage(chain, {
  CustomPallet: {
    SomeValue: 42,
    SomeMap: [[key, value]]
  }
});
```

### Time Travel

```typescript
// Get current timestamp
const now = await api.query.Timestamp.Now.getValue();

// Advance time by 1 hour
await chain.setTimestamp(now + 3600000);
await chain.newBlock();
```

### Produce Blocks

```typescript
// Single block
await chain.newBlock();

// Multiple blocks
for (let i = 0; i < 10; i++) {
  await chain.newBlock();
}

// Block with specific timestamp
await chain.newBlock({ timestamp: specificTime });
```

## Multi-Chain Testing

### Setup Multiple Chains

```typescript
const chains = await setupChains({
  relaychain: {
    endpoint: "wss://westend-rpc.polkadot.io",
    block: 12345678
  },
  parachains: [
    {
      paraId: 1000,
      endpoint: "wss://westend-asset-hub-rpc.polkadot.io",
      block: 12345678
    },
    {
      paraId: 1002,
      endpoint: "wss://westend-collectives-rpc.polkadot.io",
      block: 12345678
    }
  ]
});

const relayChain = chains.relaychain;
const assetHub = chains.parachains[0];
const collectives = chains.parachains[1];
```

### Test XCM

```typescript
it("transfers assets between chains", async () => {
  const initialBalance = await getBalance(relayChain, account);

  // Execute XCM transfer
  await xcmTransfer(assetHub, {
    dest: relayChain,
    amount: 1_000_000_000n,
    beneficiary: account
  });

  // Progress both chains
  await assetHub.newBlock();
  await relayChain.newBlock();

  // Verify transfer
  const finalBalance = await getBalance(relayChain, account);
  expect(finalBalance).toBeGreaterThan(initialBalance);
});
```

## Zombienet

### Configuration

`configs/network.toml`:

```toml
[relaychain]
chain = "rococo-local"
default_command = "polkadot"

[[relaychain.nodes]]
name = "alice"
validator = true

[[relaychain.nodes]]
name = "bob"
validator = true

[[parachains]]
id = 1000
chain = "asset-hub-rococo-local"

[[parachains.collators]]
name = "collator-1"
```

### Launch Network

```bash
# Start network
npm run zombienet

# Custom config
zombienet spawn ./configs/custom.toml

# Specify binaries
zombienet spawn ./configs/network.toml \
  --relaychain-bin=/path/to/polkadot \
  --parachain-bin=/path/to/parachain
```

### Test Against Zombienet

```typescript
describe("Zombienet Tests", () => {
  it("connects to network", async () => {
    // Relay chain
    const relayProvider = getWsProvider("ws://127.0.0.1:9944");
    const relayClient = createClient(relayProvider);
    const relayApi = relayClient.getTypedApi(relayDescriptor);

    // Parachain
    const paraProvider = getWsProvider("ws://127.0.0.1:9946");
    const paraClient = createClient(paraProvider);
    const paraApi = paraClient.getTypedApi(paraDescriptor);

    // Test network
    const relayBlock = await relayApi.query.System.Number.getValue();
    const paraBlock = await paraApi.query.System.Number.getValue();

    expect(relayBlock).toBeGreaterThan(0);
    expect(paraBlock).toBeGreaterThan(0);
  });
});
```

## Common Test Patterns

### Pattern 1: Before/After State Check

```typescript
it("modifies state correctly", async () => {
  // Before
  const beforeBalance = await getBalance(api, account);

  // Execute
  await transfer(recipient, amount);
  await chain.newBlock();

  // After
  const afterBalance = await getBalance(api, account);
  expect(afterBalance).toBe(beforeBalance - amount - fees);
});
```

### Pattern 2: Event Verification

```typescript
it("emits correct events", async () => {
  await tx.signAndSubmit(signer);
  await chain.newBlock();

  const events = await api.query.System.Events.getValue();
  const transfers = events.filter(e => e.type === "Balances.Transfer");

  expect(transfers).toHaveLength(1);
  expect(transfers[0].data.from).toBe(sender);
  expect(transfers[0].data.to).toBe(recipient);
});
```

### Pattern 3: Error Testing

```typescript
it("handles errors", async () => {
  // Insufficient balance
  await expect(
    transfer(999_999_999_999_999n)
  ).rejects.toThrow();

  // Invalid parameters
  await expect(
    transfer(0n)
  ).rejects.toThrow();
});
```

### Pattern 4: Batch Operations

```typescript
it("processes batch operations", async () => {
  const calls = [
    api.tx.Balances.transfer_allow_death({ dest: addr1, value: 1000n }),
    api.tx.Balances.transfer_allow_death({ dest: addr2, value: 2000n }),
    api.tx.Balances.transfer_allow_death({ dest: addr3, value: 3000n })
  ];

  const batchTx = api.tx.Utility.batch({ calls });
  await batchTx.signAndSubmit(signer);
  await chain.newBlock();

  // Verify all transfers
  for (const addr of [addr1, addr2, addr3]) {
    const account = await api.query.System.Account.getValue(addr);
    expect(account.data.free).toBeGreaterThan(0n);
  }
});
```

## Advanced Testing

### Runtime Upgrade

```typescript
it("tests runtime upgrade", async () => {
  const beforeVersion = await api.constants.System.Version();

  // Upload new runtime
  const code = fs.readFileSync("./runtime.wasm");
  const upgradeTx = api.tx.System.set_code({
    code: Array.from(code)
  });

  await upgradeTx.signAndSubmit(rootSigner);
  await chain.newBlock();

  const afterVersion = await api.constants.System.Version();
  expect(afterVersion.spec_version).toBeGreaterThan(beforeVersion.spec_version);
});
```

### Governance Testing

```typescript
it("tests governance proposal", async () => {
  // Submit proposal
  const proposalTx = api.tx.Democracy.propose({
    proposal: call,
    value: 1_000_000_000n
  });

  await proposalTx.signAndSubmit(signer);
  await chain.newBlock();

  // Verify proposal
  const proposals = await api.query.Democracy.PublicProps.getValue();
  expect(proposals.length).toBeGreaterThan(0);
});
```

### Staking Testing

```typescript
it("tests staking operations", async () => {
  // Bond tokens
  const bondTx = api.tx.Staking.bond({
    value: 1_000_000_000_000n,
    payee: "Staked"
  });

  await bondTx.signAndSubmit(signer);
  await chain.newBlock();

  // Verify bonding
  const ledger = await api.query.Staking.Ledger.getValue(stashAccount);
  expect(ledger.active).toBe(1_000_000_000_000n);
});
```

## Helper Utilities

### Balance Checker

```typescript
async function getBalance(api, address: string): Promise<bigint> {
  const account = await api.query.System.Account.getValue(address);
  return account.data.free;
}
```

### Event Filter

```typescript
async function getEvents(api, eventType: string) {
  const events = await api.query.System.Events.getValue();
  return events.filter(e => e.type === eventType);
}
```

### Wait for Condition

```typescript
async function waitFor(condition: () => Promise<boolean>, timeout = 10000) {
  const start = Date.now();
  while (Date.now() - start < timeout) {
    if (await condition()) return;
    await new Promise(resolve => setTimeout(resolve, 100));
  }
  throw new Error("Timeout waiting for condition");
}
```

### Chain Sync

```typescript
async function syncChains(chains: any[], blocks = 1) {
  for (let i = 0; i < blocks; i++) {
    await Promise.all(chains.map(chain => chain.newBlock()));
  }
}
```

## Performance Tips

### Parallel Tests

```typescript
describe.concurrent("Parallel Tests", () => {
  it("test 1", async () => { /* ... */ });
  it("test 2", async () => { /* ... */ });
  it("test 3", async () => { /* ... */ });
});
```

### Reuse Instances

```typescript
// Setup once
let sharedChain;

beforeAll(async () => {
  sharedChain = await setupChains(config);
});

// Reuse in tests
it("test", async () => {
  await sharedChain.newBlock();
});
```

### Cache Chain State

```bash
# Chopsticks caches in .chopsticks/
# Clear if needed
rm -rf .chopsticks
```

## Debugging

### Enable Logs

```typescript
await setupChains({
  endpoint: "wss://...",
  logLevel: "debug"
});
```

### Inspect Storage

```typescript
// Dump storage
const storage = await api.query.System.Account.getEntries();
console.log(JSON.stringify(storage, null, 2));
```

### Trace Transactions

```typescript
const result = await tx.signAndSubmit(signer);
console.log("Tx hash:", result.txHash);
console.log("Block:", result.blockHash);
```

## CI/CD Integration

### GitHub Actions

```yaml
name: Test
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 20
      - run: npm install
      - run: npm test
```

### Test Script

```json
{
  "scripts": {
    "test": "vitest run",
    "test:watch": "vitest",
    "test:ci": "vitest run --reporter=junit --outputFile=test-results.xml"
  }
}
```

## License

MIT OR Apache-2.0
