name: "Setup Polkadot omni-node"
description: "Installs and configures Polkadot omni-node"

inputs:
  omni-node-version:
    description: "Polkadot omni-node version"
    required: true

outputs:
  version:
    description: "Installed omni-node version"
    value: ${{ steps.verify.outputs.version }}
  binary-path:
    description: "Path to polkadot-omni-node binary"
    value: ${{ steps.verify.outputs.path }}
  cache-hit:
    description: "Whether binary cache was hit"
    value: ${{ steps.cache.outputs.cache-hit }}

runs:
  using: "composite"
  steps:
    - name: Validate inputs
      shell: bash
      run: |
        if [[ ! "${{ inputs.omni-node-version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "âŒ Invalid version format: ${{ inputs.omni-node-version }}"
          echo "Expected format: X.Y.Z (e.g., 0.5.0)"
          exit 1
        fi

    - name: Cache omni-node binary
      id: cache
      uses: actions/cache@v4
      with:
        path: ~/.cargo/bin/polkadot-omni-node
        key: ${{ runner.os }}-${{ runner.arch }}-omni-node-${{ inputs.omni-node-version }}

    - name: Check if binary exists after cache restore
      id: check-binary
      shell: bash
      run: |
        if [ -f ~/.cargo/bin/polkadot-omni-node ] && [ -x ~/.cargo/bin/polkadot-omni-node ]; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "âœ… Binary found in cache"
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "âš ï¸ Binary not found in cache, will install"
        fi

    - name: Install Polkadot omni-node
      if: steps.check-binary.outputs.exists != 'true'
      shell: bash
      run: |
        echo "ğŸ”§ Installing polkadot-omni-node@${{ inputs.omni-node-version }}..."

        cargo install polkadot-omni-node --version ${{ inputs.omni-node-version }} --locked --force
        echo "âœ… Installation completed"

    - name: Add Cargo bin to PATH
      shell: bash
      run: echo "${HOME}/.cargo/bin" >> $GITHUB_PATH

    - name: Verify installation
      id: verify
      shell: bash
      run: |
        echo "ğŸ” Verifying polkadot-omni-node installation..."

        # Add to PATH for this step since GITHUB_PATH only affects subsequent steps
        export PATH="${HOME}/.cargo/bin:$PATH"

        if ! command -v polkadot-omni-node &> /dev/null; then
          echo "âŒ polkadot-omni-node not found in PATH"
          exit 1
        fi
        
        VERSION_OUTPUT=$(polkadot-omni-node --version | awk '{print $2}')
        BINARY_PATH=$(which polkadot-omni-node)
        
        echo "âœ… polkadot-omni-node found at: $BINARY_PATH"
        echo "âœ… Version: $VERSION_OUTPUT"
        
        echo "version=$VERSION_OUTPUT" >> $GITHUB_OUTPUT
        echo "path=$BINARY_PATH" >> $GITHUB_OUTPUT
        
        echo "ğŸ§ª Testing basic functionality..."
        if polkadot-omni-node --help > /dev/null 2>&1; then
          echo "âœ… polkadot-omni-node is working correctly"
        else
          echo "âŒ polkadot-omni-node failed basic functionality test"
          exit 1
        fi
