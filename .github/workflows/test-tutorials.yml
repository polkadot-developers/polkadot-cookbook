name: PR Tutorial Tests

# This workflow tests tutorials on pull requests.
# Version resolution uses the polkadot-cookbook SDK which merges:
# - Global versions from /versions.yml (defaults)
# - Tutorial-specific versions from tutorials/{slug}/versions.yml (overrides)
#
# Triggers:
# - Changes to any file in tutorials/** (except scripts/)
# - Changes to global versions.yml
# - Changes to any tutorial's versions.yml file

on:
  pull_request:
    paths:
      - 'tutorials/**'
      - '!tutorials/**/scripts/**'
      - 'versions.yml'              # Trigger when global versions change
      - '**/versions.yml'           # Trigger when any tutorial versions change
  workflow_dispatch:
    inputs:
      tutorial_slug:
        description: 'Tutorial slug to test (e.g., zero-to-hero)'
        required: true
        type: string

jobs:
  find-changed-tutorials:
    runs-on: ubuntu-latest
    outputs:
      tutorials: ${{ steps.changed.outputs.tutorials }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - id: changed
        env:
          GH_EVENT: ${{ github.event_name }}
          TUTORIAL_SLUG: ${{ inputs.tutorial_slug }}
        run: |
          set -e
          BASE_SHA=${{ github.event.pull_request.base.sha }}
          HEAD_SHA=${{ github.sha }}
          echo "Base: $BASE_SHA"
          echo "Head: $HEAD_SHA"

          # Manual trigger: honor provided tutorial_slug
          if [ "$GH_EVENT" = "workflow_dispatch" ] && [ -n "$TUTORIAL_SLUG" ]; then
            ARR=$(printf '%s\n' "$TUTORIAL_SLUG" | jq -R . | jq -s .)
            {
              echo "tutorials<<__JSON__"
              echo "$ARR"
              echo "__JSON__"
            } >> "$GITHUB_OUTPUT"
            echo "Manual run for tutorial: $ARR" | tr -d '\n' || true
            exit 0
          fi
          # List added tutorial slugs
          ADDED=$(git diff --name-status "$BASE_SHA" "$HEAD_SHA" | awk '/^A\t/ {print $2}' | grep '^tutorials/' | cut -d'/' -f2 | sort -u || true)
          if [ -n "$ADDED" ]; then
            ARR=$(printf '%s\n' $ADDED | jq -R . | jq -s .)
            {
              echo "tutorials<<__JSON__"
              echo "$ARR"
              echo "__JSON__"
            } >> "$GITHUB_OUTPUT"
            echo "Added tutorials: $ARR" | tr -d '\n' || true
            exit 0
          fi
          # No newly added tutorials: skip tests
          echo 'tutorials=[]' >> $GITHUB_OUTPUT
          echo "No newly added tutorials detected; skipping tests."

  test:
    needs: find-changed-tutorials
    if: needs.find-changed-tutorials.outputs.tutorials != '[]'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        slug: ${{ fromJson(needs.find-changed-tutorials.outputs.tutorials) }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm
          cache-dependency-path: tutorials/${{ matrix.slug }}/package-lock.json
      - name: Setup Rust toolchain for CLI
        uses: dtolnay/rust-toolchain@stable
      - name: Cache CLI Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-cli-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-cli-
      - name: Build polkadot-cookbook CLI
        run: cargo build --package polkadot-cookbook-cli --release
      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
      - name: Read tutorial requirements
        id: needs
        run: |
          NEEDS_NODE=$(yq -r '.needs_node // false' tutorials/${{ matrix.slug }}/tutorial.config.yml)
          echo "needs-node=$NEEDS_NODE" >> $GITHUB_OUTPUT
      - name: Resolve tool versions using SDK
        id: resolve
        if: steps.needs.outputs.needs-node == 'true'
        run: |
          # Use the polkadot-cookbook CLI to resolve versions
          # This uses the SDK's version management to merge global and tutorial-specific versions
          eval $(./target/release/create-tutorial versions ${{ matrix.slug }} --ci)
          echo "rust=$RUST" >> $GITHUB_OUTPUT
          echo "chain-spec-builder=$CHAIN_SPEC_BUILDER" >> $GITHUB_OUTPUT
          echo "omni-node=$POLKADOT_OMNI_NODE" >> $GITHUB_OUTPUT
      - name: Cache rustup toolchains
        if: steps.needs.outputs.needs-node == 'true'
        uses: actions/cache@v4
        with:
          path: |
            ~/.rustup/toolchains
            ~/.rustup/update-hashes
          key: ${{ runner.os }}-rustup-${{ steps.resolve.outputs.rust }}
      - name: Setup Rust toolchain
        if: steps.needs.outputs.needs-node == 'true'
        uses: ./.github/actions/setup-rust
        with:
          rust-version: ${{ steps.resolve.outputs.rust }}
      - name: Setup chain-spec-builder
        if: steps.needs.outputs.needs-node == 'true'
        uses: ./.github/actions/setup-chain-spec-builder
        with:
          chain-spec-builder-version: ${{ steps.resolve.outputs.chain-spec-builder }}
      - name: Setup polkadot-omni-node
        if: steps.needs.outputs.needs-node == 'true'
        uses: ./.github/actions/setup-omni-node
        with:
          omni-node-version: ${{ steps.resolve.outputs.omni-node }}
      - name: Cache Rust build (kitchensink-parachain)
        if: steps.needs.outputs.needs-node == 'true'
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            kitchensink-parachain -> target
      - name: Build kitchensink runtime
        if: steps.needs.outputs.needs-node == 'true'
        working-directory: kitchensink-parachain
        run: |
          cargo build --release
      - name: Generate chain spec
        if: steps.needs.outputs.needs-node == 'true'
        working-directory: kitchensink-parachain
        run: |
          chain-spec-builder create -t development --relay-chain paseo --para-id 1000 \
            --runtime ./target/release/wbuild/parachain-template-runtime/parachain_template_runtime.compact.compressed.wasm \
            named-preset development
      - name: Start polkadot-omni-node
        if: steps.needs.outputs.needs-node == 'true'
        working-directory: kitchensink-parachain
        run: |
          nohup polkadot-omni-node --chain ./chain_spec.json --dev --rpc-cors all --rpc-methods unsafe >/dev/null 2>&1 &
          for i in $(seq 1 20); do
            if curl -s -X POST -H "Content-Type: application/json" -d '{"jsonrpc":"2.0","method":"system_health","params":[],"id":1}' http://127.0.0.1:9944 >/dev/null 2>&1; then
              echo "RPC is up"; break; fi; sleep 1; done
      - name: Install deps
        working-directory: tutorials/${{ matrix.slug }}
        run: npm ci || npm i
      - name: Run tests
        working-directory: tutorials/${{ matrix.slug }}
        run: npm run test --silent


