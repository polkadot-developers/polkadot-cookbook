name: Test Polkadot SDK Recipes

on:
  pull_request:
    paths:
      - 'recipes/**'
      - '.github/workflows/test-polkadot-sdk-recipes.yml'
  push:
    branches:
      - master
    paths:
      - 'recipes/**'
  workflow_dispatch:
    inputs:
      recipe_slug:
        description: 'Recipe slug to test (e.g., basic-pallet)'
        required: false
        type: string

jobs:
  find-changed-recipes:
    runs-on: ubuntu-latest
    outputs:
      recipes: ${{ steps.changed.outputs.recipes }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - id: changed
        env:
          GH_EVENT: ${{ github.event_name }}
          RECIPE_SLUG: ${{ inputs.recipe_slug }}
        run: |
          set -e

          # Manual trigger: use provided recipe_slug
          if [ "$GH_EVENT" = "workflow_dispatch" ] && [ -n "$RECIPE_SLUG" ]; then
            echo "recipes=[\"$RECIPE_SLUG\"]" >> $GITHUB_OUTPUT
            echo "Manual run for recipe: $RECIPE_SLUG"
            exit 0
          fi

          # Push to master: test all recipes
          if [ "$GH_EVENT" = "push" ]; then
            RECIPES=$(find recipes -mindepth 1 -maxdepth 1 -type d -exec basename {} \; | jq -R -s -c 'split("\n")[:-1]')
            echo "recipes=$RECIPES" >> $GITHUB_OUTPUT
            echo "Testing all recipes: $RECIPES"
            exit 0
          fi

          # PR: find changed recipes
          BASE_SHA=${{ github.event.pull_request.base.sha }}
          HEAD_SHA=${{ github.sha }}

          # Get changed recipe directories
          CHANGED=$(git diff --name-only "$BASE_SHA" "$HEAD_SHA" | grep '^recipes/' | cut -d'/' -f2 | sort -u | jq -R -s -c 'split("\n")[:-1]')

          if [ "$CHANGED" = "[]" ] || [ -z "$CHANGED" ]; then
            echo "recipes=[]" >> $GITHUB_OUTPUT
            echo "No recipe changes detected"
          else
            echo "recipes=$CHANGED" >> $GITHUB_OUTPUT
            echo "Changed recipes: $CHANGED"
          fi

  test-polkadot-sdk:
    needs: find-changed-recipes
    if: needs.find-changed-recipes.outputs.recipes != '[]'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        slug: ${{ fromJson(needs.find-changed-recipes.outputs.recipes) }}

    steps:
      - uses: actions/checkout@v4

      - name: Check recipe type
        id: recipe-type
        working-directory: recipes/${{ matrix.slug }}
        run: |
          if [ -f "recipe.config.yml" ]; then
            TYPE=$(grep '^type:' recipe.config.yml | awk '{print $2}')
            echo "type=$TYPE" >> $GITHUB_OUTPUT
            echo "Recipe type: $TYPE"
          else
            echo "type=unknown" >> $GITHUB_OUTPUT
            echo "No recipe.config.yml found"
          fi

      - name: Setup Rust toolchain
        if: steps.recipe-type.outputs.type == 'polkadot-sdk'
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache Rust dependencies
        if: steps.recipe-type.outputs.type == 'polkadot-sdk'
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: recipes/${{ matrix.slug }}

      - name: Check formatting
        if: steps.recipe-type.outputs.type == 'polkadot-sdk'
        working-directory: recipes/${{ matrix.slug }}
        run: cargo fmt --all -- --check

      - name: Run clippy
        if: steps.recipe-type.outputs.type == 'polkadot-sdk'
        working-directory: recipes/${{ matrix.slug }}
        run: cargo clippy --all-features --all-targets -- -D warnings

      - name: Build
        if: steps.recipe-type.outputs.type == 'polkadot-sdk'
        working-directory: recipes/${{ matrix.slug }}
        run: cargo build --release

      - name: Run tests
        if: steps.recipe-type.outputs.type == 'polkadot-sdk'
        working-directory: recipes/${{ matrix.slug }}
        run: cargo test --all-features

      - name: Skip non-Polkadot SDK recipes
        if: steps.recipe-type.outputs.type != 'polkadot-sdk'
        run: |
          echo "Skipping ${{ matrix.slug }} (type: ${{ steps.recipe-type.outputs.type }})"
          echo "This workflow only tests polkadot-sdk recipes"
