#!/bin/sh
# Commit message validation hook
# Enforces conventional commit format for semantic versioning

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Skip merge commits, reverts, and release commits from CI
if echo "$COMMIT_MSG" | grep -qE "^(Merge|Revert|chore\(release\))"; then
    exit 0
fi

# Valid conventional commit types
VALID_TYPES="feat|fix|docs|test|refactor|chore|ci|build|perf|style"
# Pattern allows optional scope, optional breaking change marker (!), and description
PATTERN="^($VALID_TYPES)(\(.+\))?(!)?:.{1,}"

if ! echo "$COMMIT_MSG" | head -n1 | grep -qE "$PATTERN"; then
    echo ""
    echo "‚ùå ERROR: Commit message must follow conventional commit format"
    echo ""
    echo "  Required format: <type>(<scope>): <description>"
    echo ""
    echo "  For breaking changes: <type>(<scope>)!: <description>"
    echo ""
    echo "  Examples:"
    echo "    feat(recipe): add basic pallet example"
    echo "    fix(cli): correct validation bug"
    echo "    docs: update README with new instructions"
    echo "    feat(recipe)!: redesign config format (breaking)"
    echo ""
    echo "  Valid types:"
    echo "    feat     - New feature (triggers MINOR version bump)"
    echo "    fix      - Bug fix (triggers PATCH version bump)"
    echo "    docs     - Documentation only"
    echo "    test     - Adding tests"
    echo "    refactor - Code refactoring"
    echo "    chore    - Maintenance tasks"
    echo "    ci       - CI/CD changes"
    echo "    build    - Build system changes"
    echo "    perf     - Performance improvements"
    echo "    style    - Code style/formatting"
    echo ""
    echo "  Add '!' before colon for breaking changes (triggers MAJOR version bump)"
    echo ""
    echo "  üí° Tip: Use --no-verify to bypass this check (use sparingly!)"
    echo ""
    exit 1
fi

# Check for breaking change marker in message body
if echo "$COMMIT_MSG" | grep -q "BREAKING CHANGE:"; then
    echo "‚úì Breaking change detected in commit message body"
fi

# Success
exit 0
